name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.ref_name }}

jobs:
  docker-build-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Set image names
        id: img
        run: |
          OWNER=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)
          REPO=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          echo "FRONT=${{ env.REGISTRY }}/${OWNER}/${REPO}-frontend:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "BACK=${{ env.REGISTRY }}/${OWNER}/${REPO}-backend:${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Build Frontend
        if: exists('apps/frontend/Dockerfile')
        run: |
          docker build -t "${{ steps.img.outputs.FRONT }}" apps/frontend
          docker push "${{ steps.img.outputs.FRONT }}"

      - name: Build Backend
        if: exists('apps/backend/Dockerfile')
        run: |
          docker build -t "${{ steps.img.outputs.BACK }}" apps/backend
          docker push "${{ steps.img.outputs.BACK }}"

      - name: Export images
        run: |
          echo "front=${{ steps.img.outputs.FRONT }}" >> $GITHUB_ENV
          echo "back=${{ steps.img.outputs.BACK }}" >> $GITHUB_ENV

  rollout:
    name: Kubernetes Rollout
    needs: docker-build-push
    runs-on: ubuntu-latest
    env:
      KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        run: |
          echo "${KUBE_CONFIG}" | base64 -d > $HOME/.kube/config
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

      - name: Set images
        run: |
          set -e
          if kubectl -n "$KUBE_NAMESPACE" get deploy sf1-frontend >/dev/null 2>&1; then
            kubectl -n "$KUBE_NAMESPACE" set image deploy/sf1-frontend '*=${{ env.front }}'
          fi
          if kubectl -n "$KUBE_NAMESPACE" get deploy sf1-backend >/dev/null 2>&1; then
            kubectl -n "$KUBE_NAMESPACE" set image deploy/sf1-backend '*=${{ env.back }}'
          fi

      - name: Wait rollout
        run: |
          if kubectl -n "$KUBE_NAMESPACE" get deploy sf1-frontend >/dev/null 2>&1; then
            kubectl -n "$KUBE_NAMESPACE" rollout status deploy/sf1-frontend --timeout=180s
          fi
          if kubectl -n "$KUBE_NAMESPACE" get deploy sf1-backend >/dev/null 2>&1; then
            kubectl -n "$KUBE_NAMESPACE" rollout status deploy/sf1-backend --timeout=180s
          fi