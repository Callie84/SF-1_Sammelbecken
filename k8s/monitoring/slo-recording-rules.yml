apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: sf1-slo-recording
  namespace: monitoring
  labels:
    role: slo
    app: sf1
spec:
  groups:
    - name: api.slo
      interval: 30s
      rules:
        # Requestâ€‘ZÃ¤hler aus Histogramm ableiten
        - record: job:http_requests:rate5m
          expr: sum by (service) (rate(http_request_duration_seconds_count{service="api"}[5m]))
        - record: job:http_errors:rate5m
          expr: sum by (service) (rate(http_request_duration_seconds_count{service="api",status_code=~"5.."}[5m]))
        - record: job:http_error_ratio:rate5m
          expr: job:http_errors:rate5m / job:http_requests:rate5m

        # Latenzâ€‘Quantile
        - record: job:latency:p95:5m
          expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{service="api"}[5m])))
        - record: job:latency:p99:5m
          expr: histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service="api"}[5m])))

        # 30â€‘Tage Fehlerrate (approximiert Ã¼ber 4w)
        - record: job:http_error_ratio:30d
          expr: (sum by (service) (rate(http_request_duration_seconds_count{service="api",status_code=~"5.."}[30d]))) /
                (sum by (service) (rate(http_request_duration_seconds_count{service="api"}[30d])))

        # Burnâ€‘Rate Fenster (SREâ€‘Methode)
        - record: job:burnrate:5m
          expr: job:http_error_ratio:rate5m / 0.001
        - record: job:burnrate:1h
          expr: (sum by (service) (rate(http_request_duration_seconds_count{service="api",status_code=~"5.."}[1h]))) /
                (sum by (service) (rate(http_request_duration_seconds_count{service="api"}[1h]))) / 0.001

    - name: ext.availability
      interval: 30s
      rules:
        - record: ext:availability:rate5m
          expr: avg_over_time(probe_success{job="blackbox",instance="https://seedfinderpro.de"}[5m])
        - record: ext:availability:30d
          expr: avg_over_time(probe_success{job="blackbox",instance="https://seedfinderpro.de"}[30d])